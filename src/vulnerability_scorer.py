"""
Vulnerability Scorer Module

Calculates country-level risk scores based on tariff exposure,
trade dependency, and deal status to estimate vulnerability
during the 2025â€“2026 tariff war.

Author: Harsh Mudgal
Date: February 2026
"""

import pandas as pd
import numpy as np

class GlobalVulnerabilityScorer:
    """
    Compute weighted vulnerability scores for each country based on
    tariffs, trade exposure, and political deal status.
    """
    DEAL_STATUS_SCORES = {
        'Imposing Country': 0,
        'Best Deal': 5,
        'Deal Reached': 15,
        'Extended Truce': 20,
        'Partial Deal': 25,
        'Interim Agreement': 30,
        'Deal Announced': 35,
        'No Full Deal': 70,
        'No Deal': 100
    }

    def __init__(self, data: pd.DataFrame):
        self.data = data

    def score_all_countries(self) -> pd.DataFrame:
        """
        Calculate vulnerability scores for all countries using
        latest available year data.
        Returns ranked DataFrame from highest to lowest risk.
        """

        latest = self.data[self.data['year'] == self.data['year'].max()].copy()

        results = []
        for _, row in latest.iterrows():
            # Factor 1: Tariff (Direct tax pain)
            tariff_rate = row.get('tariff_current_feb2026', 0) or 0
            tariff_score = min(tariff_rate, 100)
            
            # Factor 2: Trade dependency (How much they rely on trade)
            trade_dep = row.get('trade_pct_gdp', 50) or 50
            trade_score = min(trade_dep, 100)
            
            # Factor 3: Political Deal (Penalty points from our dictionary)
            deal_status = row.get('deal_status', 'No Deal')
            deal_score = self.DEAL_STATUS_SCORES.get(deal_status, 50)
            
            # THE FORMULA: 50% Tariffs + 30% Trade + 20% Politics
            vulnerability = (
                tariff_score * 0.50 +
                trade_score * 0.30 +
                deal_score * 0.20
            )
            results.append({
                'country_code': row['country_code'],
                'country_name': row['country_name'],
                'current_tariff': tariff_rate,
                'peak_tariff': row.get('tariff_peak', tariff_rate),
                'trade_dependency_pct': round(trade_dep, 1),
                'deal_status': deal_status,
                'vulnerability_score': round(vulnerability, 1),
                'risk_level': self._risk_label(vulnerability),
                'notes': row.get('special_notes', '')
            })
        
        return pd.DataFrame(results).sort_values(
            'vulnerability_score', ascending=False
        ).reset_index(drop=True)
    
    def _risk_label(self, score: float) -> str:
        """Convert numeric score into categorical risk label."""

        if score >= 40: 
            return 'ğŸ”´ CRITICAL'    
        elif score >= 28: 
            return 'ğŸŸ  HIGH'      
        elif score >= 15: 
            return 'ğŸŸ¡ MEDIUM'    
        else: 
            return 'ğŸŸ¢ LOW'                   

if __name__ == "__main__":
    import os
    base_dir = os.path.dirname(os.path.abspath(__file__))
    data_path = os.path.join(base_dir, '..', 'data', 'processed', 'trade_data_global.csv')
    
    try:
        df = pd.read_csv(data_path)
        scorer = GlobalVulnerabilityScorer(df)
        results = scorer.score_all_countries()
        
        print("\nâœ… Success! Scored results:")
        print(results[['country_name', 'current_tariff', 
                       'deal_status', 'vulnerability_score', 'risk_level']])
                       
    except FileNotFoundError:
        print(f"âŒ Error: Could not find the file at:\n{data_path}")
    except Exception as e:
        print(f"âŒ An unexpected error occurred: {e}")